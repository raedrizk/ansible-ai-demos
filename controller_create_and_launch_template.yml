---
- name: Create and Launch a Job template for an I generated playbook
  hosts: all
  gather_facts: false
  environment:
    GATEWAY_USERNAME: "{{ lookup('ansible.builtin.env', 'CONTROLLER_USERNAME') }}"
    GATEWAY_PASSWORD: "{{ lookup('ansible.builtin.env', 'CONTROLLER_PASSWORD') }}"
    GATEWAY_HOSTNAME: "{{ lookup('ansible.builtin.env', 'CONTROLLER_HOST') }}"
    GATEWAY_VERIFY_SSL: "{{ lookup('ansible.builtin.env', 'CONTROLLER_VERIFY_SSL') }}"
  pre_tasks:
    - name: Authenticate with platform gateway
      ansible.platform.token:
        description: Create token
        scope: write
        state: present
      register: r_authtoken

    - name: Set fact for token
      ansible.builtin.set_fact:
        controller_oauthtoken: “{{ r_authtoken.ansible_facts.aap_token.token }}”
  tasks:
  - name: Add project
    ansible.controller.project:
      name: "AI Generated Playbooks"
      description: "Playbooks generated by Lightspeed"
      organization: "{{ input_organization | default('Foxhound') }}"
      scm_type: git
      scm_url: "{{ input_git_repo | default('https://github.com/raedrizk/ansible_ai_generated_playbooks.git') }}"
      scm_branch: "{{ input_git_branch | default('main') }}"
      update_project: true
      state: present

  - name: Create job template from the generated playbook
    ansible.controller.job_template:
      name: "BOT_AI_Generated_Playbook"
      job_type: "run"
      organization: "{{ input_organization | default('Foxhound') }}"
      inventory: "{{ input_inventory | default('Foxhound Inventory') }}"
      limit: "{{ input_limit | default('api.foxhound.unit') }}"
      project: "AI Generated Playbooks"
      playbook: "{{ generated_playbook_name | default('generated_playbook.yml') }}"
      become_enabled: true
      credentials:
        - "{{ input_credential | default('foxhound-lab-admin') }}"
      state: present

  # - name: Launch a job
  #   ansible.controller.job_launch:
  #     organization: "{{ input_organization | default('Foxhound') }}"
  #     name: "AI Generated Playbook"
  #     wait: true
  #   register: ai_job_result

  - name: Create a workflow job template with workflow nodes in template
    ansible.controller.workflow_job_template:
      name: WF_AIDemo_apply_ai_generated_playbook
      description: "Workflow job template to apply AI generated playbook"
      organization: "{{ input_organization | default('Foxhound') }}"
      workflow_nodes:
        - identifier: snow_update_fail
          all_parents_must_converge: false
          unified_job_template:
            organization:
              name: "{{ input_organization | default('Foxhound') }}"
            name: ServiceNowDemo_snow_update_Incident
            type: job_template
            extra_data:
              snow_update_comments: "Running AI generated playbook Failed"
        - identifier: slack_update_fail
          all_parents_must_converge: false
          unified_job_template:
            organization:
              name: "{{ input_organization | default('Foxhound') }}"
            name: AIDemo_slack_post_message
            type: job_template
            extra_data:
              slack_message: "Running AI generated playbook Failed"
              slack_message_color: "danger"
        - identifier: snow_update_success
          all_parents_must_converge: false
          unified_job_template:
            organization:
              name: "{{ input_organization | default('Foxhound') }}"
            name: ServiceNowDemo_snow_update_Incident
            type: job_template
            extra_data:
              snow_update_comments: "Running AI generated playbook Success"
        - identifier: slack_update_success
          all_parents_must_converge: false
          unified_job_template:
            organization:
              name: "{{ input_organization | default('Foxhound') }}"
            name: AIDemo_slack_post_message
            type: job_template
            extra_data:
              slack_message: "Running AI generated playbook Success"
              slack_message_color: "good"
        - identifier: run_ai_generated_playbook
          all_parents_must_converge: false
          unified_job_template:
            organization:
              name: "{{ input_organization | default('Foxhound') }}"
            name: "BOT_AI_Generated_Playbook
            type: job_template"
          related:
            success_nodes:
              - identifier: snow_update_success
              - identifier: slack_update_success
            failure_nodes:
              - identifier: snow_update_fail
              - identifier: slack_update_fail
